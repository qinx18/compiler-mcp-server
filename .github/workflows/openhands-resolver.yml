name: OpenHands Resolver

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  resolver:
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'fix-me')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@openhands-agent'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools

      - name: Install OpenHands Resolver (with fallback)
        run: |
          # Try multiple installation strategies
          pip install --upgrade pip setuptools wheel
          
          # Strategy 1: Try latest version
          if ! pip install openhands-resolver; then
            echo "Latest version failed, trying with --no-deps"
            # Strategy 2: Install without dependencies and manually install what we need
            pip install --no-deps openhands-resolver
            pip install pandas pytest
            # Try to install a compatible openhands-ai version
            pip install "openhands-ai>=0.13.0" || echo "Could not install openhands-ai, continuing..."
          fi

      - name: Run OpenHands Resolver
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ secrets.PAT_USERNAME || github.actor }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'anthropic/claude-3-5-sonnet-20241022' }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
        run: |
          # Try to run the resolver, with fallback to manual issue handling
          if python -c "import openhands_resolver.resolve_issue" 2>/dev/null; then
            python -m openhands_resolver.resolve_issue \
              --issue-number ${{ github.event.issue.number }} \
              --repo ${{ github.repository }}
          else
            echo "OpenHands resolver not available, adding comment to issue"
            # Fallback: Add a comment explaining the issue
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d '{"body":"⚠️ OpenHands resolver encountered dependency conflicts and could not run. Please check the workflow configuration and ensure all required secrets are set up correctly.\n\nRequired secrets:\n- PAT_TOKEN: GitHub Personal Access Token\n- LLM_API_KEY: API key for your LLM service\n- LLM_MODEL: Model name (e.g., anthropic/claude-3-5-sonnet-20241022)\n\nSee the README for setup instructions."}'
          fi
